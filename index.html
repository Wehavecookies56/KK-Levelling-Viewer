<html>
	<head>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css">
		<style>
			body{
				background-color:#202124;
				color:#FFFFFF;
			}
			table {
				margin: auto;
				width: 70%;
				padding: 10px;
				text-align: center;
			}
            th {
              background-color:#202124;
              position: sticky;
              top: 0;
            }
			.level:hover { 
				color:yellow;
				border: 1px solid yellow;
			}
            td {
                border-color: #6e6e6e;
            }
			
			.level:hover td{
                border-color: yellow;
            }
            h1 {
                margin: auto;
                width: 50%;
                text-align: center;
                padding: 10px;
            }
            .container {
                width: 50%;
                margin: auto;
                padding: 10px;
                text-align: center;
            }
            .info {
                text-align: center;
            }
            #file-selector {
                margin: 0 auto
            }
		</style>
	</head>
	<body>
        <h1>Kingdom Keys Levelling Viewer</h1>
        <p class="info">This displays the stat and ability gains from levels in Kingdom Keys. You can view the defaults included in Kingdom Keys as well as select a custom file for data packs.</p>
        <p class="info">View the raw json files <a href="https://github.com/Wehavecookies56/Kingdom-Keys/tree/master/src/main/resources/data/kingdomkeys/leveling">here</a></p>
        <div class="container">
            <div class="row">
                <div class="column column-33">
                    <input type="button" class="button button-clear" id="warrior" value="Default Warrior" onclick="fetchData('https://raw.githubusercontent.com/Wehavecookies56/Kingdom-Keys/master/src/main/resources/data/kingdomkeys/leveling/warrior.json')">
                </div>
                <div class="column column-33">
                    <input type="button" class="button button-clear" id="warrior" value="Default Mystic" onclick="fetchData('https://raw.githubusercontent.com/Wehavecookies56/Kingdom-Keys/master/src/main/resources/data/kingdomkeys/leveling/mystic.json')">
                </div>
                <div class="column column-33">
                    <input type="button" class="button button-clear" id="warrior" value="Default Guardian" onclick="fetchData('https://raw.githubusercontent.com/Wehavecookies56/Kingdom-Keys/master/src/main/resources/data/kingdomkeys/leveling/guardian.json')"> <br>
                </div>
            </div>
            <div class="row">
                <div>
                   <p>Select a custom JSON file to view</p>
                </div>
                <div class="column column-33">
		          <input type="file" id="file-selector">
                </div>
                <div class="column column-33">
		          <input type="checkbox" id="namespaces" class="namespaces" style="position:sticky;">Show namespaces</input>
                </div>
            </div>
        </div>    

		<table id="output">
			
		</table>
		<script>
			var totalStr = 1, totalMag = 1, totalDef = 1, totalAP = 0, totalHP = 20, totalMP = 0;

			function fetchData(url){
				fetch(url)
					.then(response => response.json())
					.then(json => {
						populateTable(url.substring(url.lastIndexOf("/")+1),JSON.stringify(json))
					});
			}
			
			//Write numeric stat
            function writeStat(stat,tr, totalStat){
				if(stat) {
					let plus = stat >= 0;
					const td = tr.insertCell();
					if(stat <0){
						td.style.color = "red"
					}
					td.appendChild(document.createTextNode((plus ? "+" : "")+stat+" ["+(totalStat)+"]"))
				} else {
					const td = tr.insertCell();
					td.style.color = "#888"
					td.appendChild(document.createTextNode("N/A"))
				}
			}
			
			//Write array of stats
			function writeStatArray(stat,tr){
				if(stat) {
				    const td = tr.insertCell();
					td.style.color = stat < 0 ? "red" : td.style.color;
					
					namespaces = document.querySelector('.namespaces').checked;
					if(namespaces) {
						let text = "";
						for(let j = 0; j < stat.length;j++){
							text += String(stat[j])+", "
						}
						td.appendChild(document.createTextNode(text.substring(0,text.length-2)))
					} else {
					let text = "";
						for(let j = 0; j < stat.length;j++){
							text += String(stat[j]).substring(String(stat[j]).indexOf(":") + 1)+", "
						}
						td.appendChild(document.createTextNode(text.substring(0,text.length-2)))
					}
				} else {
					const td = tr.insertCell();
					td.style.color = "#888"
					td.appendChild(document.createTextNode("N/A"))
				}
			}
			
			//Load table based on a file
			function loadTable(file){
			console.log(file)
				console.log(file.name)
				var fr = new FileReader();
				fr.onload=function(){
					populateTable(file.name,fr.result);
				}
				
				fr.readAsText(file);
			}
			
			function populateTable(name,json){
				totalStr = 1, totalMag = 1, totalDef = 1, totalAP = 0, totalHP = 20, totalMP = 0;

				console.log("Name: "+name)
				table = document.getElementById('output');
				table.border = 0;
				table.innerHTML = "";

				const obj = JSON.parse(json);
                        var thead = table.createTHead();
						const firstHeader = thead.insertRow();
						nameCell = firstHeader.insertCell();
						nameCell.appendChild(document.createTextNode(name.substring(0,name.indexOf(".")).toUpperCase()))
						nameCell.colSpan = 9;
						nameCell.style = "font-size:36px; text-align:center;";
						
						const header = table.insertRow();
						header.insertCell().outerHTML = "<th>Level</th>";
						header.insertCell().outerHTML = "<th>Strength</th>";
						header.insertCell().outerHTML = "<th>Magic</th>";
						header.insertCell().outerHTML = "<th>Defense</th>";
						header.insertCell().outerHTML = "<th>AP</th>";
						header.insertCell().outerHTML = "<th>Max HP</th>";
						header.insertCell().outerHTML = "<th>Max MP</th>";
						header.insertCell().outerHTML = "<th>Abilities</th>";
						header.insertCell().outerHTML = "<th>Shotlocks</th>";

                    var tbody = table.createTBody();

					for (let i = 0; i <= 100; i++) {
						const tr = tbody.insertRow();
						tr.className = "level"

						let level = obj[i];
						const td = tr.insertCell();
						
						td.appendChild(document.createTextNode(i))
						if(i > 0) {
							console.log(i+" "+totalAP);
							totalStr += level.str ? level.str : 0;
							totalMag += level.mag ? level.mag : 0;
							totalDef += level.def ? level.def : 0;
							totalAP += level.ap ? level.ap : 0;
							totalHP += level.maxhp ? level.maxhp : 0;
							totalMP += level.maxmp ? level.maxmp : 0;
						}
						writeStat(level.str,tr, totalStr)
						writeStat(level.mag,tr, totalMag)
						writeStat(level.def,tr, totalDef)
						writeStat(level.ap,tr, totalAP)
						writeStat(level.maxhp,tr, totalHP)
						writeStat(level.maxmp,tr, totalMP)
						writeStatArray(level.abilities,tr)
						writeStatArray(level.shotlocks,tr)
					}
			}
			
			const fileSelector = document.getElementById('file-selector');
			fileSelector.addEventListener('change', (event) => {
				const files = event.target.files;
				loadTable(files[0]);
			  });
			  
			const checkbox = document.getElementById('namespaces');
			checkbox.addEventListener('change', (event) => {
				const file = fileSelector.files[0];
				loadTable(file);
			  });

		</script>
	</body>
</html>
